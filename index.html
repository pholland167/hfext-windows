<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H&F Exteriors - Window Measurement App</title>
    <!-- Using Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Using jsPDF and jsPDF-AutoTable for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Custom focus ring color to match the brand */
        input:focus, select:focus, textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #9D2235;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b3b3b3; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto max-w-3xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-[#9D2235]">H&F Exteriors</h1>
            <p class="text-lg text-gray-600">Window Measurement App - v2.5</p>
        </header>

        <!-- Status/Message Area to replace alerts -->
        <div id="statusMessage" class="hidden p-4 mb-6 text-center text-white rounded-lg transition-all duration-300"></div>

        <!-- PO Loading Section -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">1. Input PO</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="poNumber" placeholder="Enter PO Number" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-[#9D2235]">
                <button id="loadPoBtn" class="w-full sm:w-auto bg-[#9D2235] text-white font-bold py-2 px-6 rounded-lg hover:bg-red-800 transition-colors duration-300 flex items-center justify-center">
                    <svg id="loadingIcon" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Input PO</span>
                </button>
            </div>
            <p id="currentPoInfo" class="mt-4 text-sm text-gray-500">No PO inputted.</p>
        </div>

        <!-- Window Entry Form -->
        <div id="entryForm" class="bg-white p-6 rounded-xl shadow-md mb-8 opacity-50 pointer-events-none">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">2. Add a Window</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <!-- Location and Type are always visible after PO load -->
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-600 mb-1">Window Location *</label>
                    <input type="text" id="location" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="type" class="block text-sm font-medium text-gray-600 mb-1">Window Type *</label>
                    <select id="type" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select Window Type</option>
                        <option>Single Hung</option>
                        <option>Double Hung</option>
                        <option>Picture</option>
                        <option>Casement</option>
                        <option>Round</option>
                        <option>Half-Round</option>
                        <option>Other</option>
                    </select>
                </div>
                <div id="otherTypeWrapper" class="hidden md:col-span-2">
                    <label for="otherType" class="block text-sm font-medium text-gray-600 mb-1">Specify Other Type *</label>
                    <input type="text" id="otherType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>

            <!-- Measurement section, hidden until a type is selected -->
            <div id="measurementContainer" class="hidden mt-6 border-t pt-6">
                
                <!-- Detailed Measurements for standard windows -->
                <div id="detailedMeasurementContainer" class="hidden">
                    <!-- Transom Option -->
                    <div id="transomOptionContainer" class="hidden md:col-span-2 border-b pb-4 mb-4">
                        <div class="relative flex items-start">
                            <div class="flex h-6 items-center">
                                <input id="transomCheckbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-[#9D2235] focus:ring-[#9D2235]">
                            </div>
                            <div class="ml-3 text-sm leading-6">
                                <label for="transomCheckbox" class="font-medium text-gray-900">Add Transom?</label>
                            </div>
                        </div>
                        <div id="transomDetailsWrapper" class="hidden mt-4 space-y-4">
                            <div>
                                <label for="transomShape" class="block text-sm font-medium text-gray-600 mb-1">Transom Shape</label>
                                <select id="transomShape" class="w-full md:w-1/3 px-2 py-2 border border-gray-300 rounded-lg">
                                    <option>Rectangular</option>
                                    <option>Half-Round</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div id="otherTransomShapeWrapper" class="hidden">
                                <label for="otherTransomShape" class="block text-sm font-medium text-gray-600 mb-1">Specify Shape</label>
                                <input type="text" id="otherTransomShape" placeholder="e.g. Elliptical" class="w-full md:w-1/3 px-2 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label for="transomHeight" class="block text-sm font-medium text-gray-600 mb-1">Transom Height</label>
                                <input type="text" id="transomHeight" inputmode="decimal" placeholder="e.g. 12 1/8" class="w-full md:w-1/3 px-2 py-2 text-center border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">Detailed Measurements</h3>
                            <div class="grid grid-cols-3 gap-x-4">
                                <div>
                                    <label for="widthTop" class="block text-sm font-medium text-gray-600 mb-1">Width Top</label>
                                    <input type="text" id="widthTop" inputmode="decimal" placeholder="e.g. 35 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="widthMiddle" class="block text-sm font-medium text-gray-600 mb-1">Width Middle</label>
                                    <input type="text" id="widthMiddle" inputmode="decimal" placeholder="e.g. 35 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="widthBottom" class="block text-sm font-medium text-gray-600 mb-1">Width Bottom</label>
                                    <input type="text" id="widthBottom" inputmode="decimal" placeholder="e.g. 35 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                            </div>
                             <div class="grid grid-cols-3 gap-x-4 mt-4">
                                <div>
                                    <label for="heightLeft" class="block text-sm font-medium text-gray-600 mb-1">Height Left</label>
                                    <input type="text" id="heightLeft" inputmode="decimal" placeholder="e.g. 52 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="heightCenter" class="block text-sm font-medium text-gray-600 mb-1">Height Center</label>
                                    <input type="text" id="heightCenter" inputmode="decimal" placeholder="e.g. 52 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="heightRight" class="block text-sm font-medium text-gray-600 mb-1">Height Right</label>
                                    <input type="text" id="heightRight" inputmode="decimal" placeholder="e.g. 52 1/8" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col">
                             <label for="notes" class="block text-sm font-medium text-gray-600 mb-1 mt-7">Notes</label>
                            <textarea id="notes" placeholder="e.g., Temper glass, full screen..." class="w-full px-4 py-2 border border-gray-300 rounded-lg flex-grow min-h-[100px]"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Simple Measurements for Round/Half-Round windows -->
                <div id="simpleMeasurementContainer" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <h3 class="text-lg font-medium text-gray-700 mb-2">Overall Measurements</h3>
                             <div class="grid grid-cols-2 gap-x-4">
                                <div>
                                    <label for="widthSimple" class="block text-sm font-medium text-gray-600 mb-1">Width</label>
                                    <input type="text" id="widthSimple" inputmode="decimal" placeholder="e.g. 36" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="heightSimple" class="block text-sm font-medium text-gray-600 mb-1">Height</label>
                                    <input type="text" id="heightSimple" inputmode="decimal" placeholder="e.g. 36" class="w-full px-2 py-2 text-center border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                         <div class="flex flex-col">
                             <label for="notesSimple" class="block text-sm font-medium text-gray-600 mb-1">Notes</label>
                            <textarea id="notesSimple" placeholder="e.g., Temper glass..." class="w-full px-4 py-2 border border-gray-300 rounded-lg flex-grow min-h-[50px]"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Common elements for all measurement types -->
                <div id="finalSizeDisplay" class="md:col-span-2 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-r-lg hidden mt-4">
                    <p class="font-semibold">Calculated Final Size: <span id="finalSize" class="text-lg font-bold">-- × --</span></p>
                </div>
                <button id="addWindowBtn" class="md:col-span-2 w-full mt-6 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300">Save Window</button>
            </div>
        </div>
        
        <!-- Window Entries List -->
        <div class="bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">3. Saved Windows</h2>
            <div id="entries" class="space-y-3">
                <p class="text-gray-500">No windows added yet for this PO.</p>
            </div>
            <button id="generatePDFBtn" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Export PDF</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;
        let currentPoNumber = null;
        let windows = [];
        let unsubscribe = null;
        const appId = 'hf-exteriors-app'; // A unique ID for your app's data

        const DOMElements = {
            poNumberInput: document.getElementById('poNumber'),
            loadPoBtn: document.getElementById('loadPoBtn'),
            loadingIcon: document.getElementById('loadingIcon'),
            currentPoInfo: document.getElementById('currentPoInfo'),
            entryForm: document.getElementById('entryForm'),
            statusMessage: document.getElementById('statusMessage'),
            typeSelect: document.getElementById('type'),
            otherTypeWrapper: document.getElementById('otherTypeWrapper'),
            otherTypeInput: document.getElementById('otherType'),
            measurementContainer: document.getElementById('measurementContainer'),
            detailedMeasurementContainer: document.getElementById('detailedMeasurementContainer'),
            simpleMeasurementContainer: document.getElementById('simpleMeasurementContainer'),
            transomOptionContainer: document.getElementById('transomOptionContainer'),
            transomCheckbox: document.getElementById('transomCheckbox'),
            transomDetailsWrapper: document.getElementById('transomDetailsWrapper'),
            transomShapeSelect: document.getElementById('transomShape'),
            otherTransomShapeWrapper: document.getElementById('otherTransomShapeWrapper'),
            otherTransomShapeInput: document.getElementById('otherTransomShape'),
            transomHeightInput: document.getElementById('transomHeight'),
            finalSizeDisplay: document.getElementById('finalSizeDisplay'),
            finalSizeSpan: document.getElementById('finalSize'),
            addWindowBtn: document.getElementById('addWindowBtn'),
            generatePDFBtn: document.getElementById('generatePDFBtn'),
            entriesContainer: document.getElementById('entries'),
            locationInput: document.getElementById('location'),
            notesInput: document.getElementById('notes'),
            notesSimpleInput: document.getElementById('notesSimple'),
            detailedMeasurementFields: ['widthTop', 'widthMiddle', 'widthBottom', 'heightLeft', 'heightCenter', 'heightRight'],
            simpleMeasurementFields: ['widthSimple', 'heightSimple']
        };

        const parseFractionInput = (str) => {
            if (!str || typeof str !== 'string') return NaN;
            str = str.trim();
            const parts = str.split(' ');
            let total = 0;
            if (parts.length > 0 && parts[0].includes('/')) {
                const [num, den] = parts[0].split('/').map(Number);
                if (!isNaN(num) && !isNaN(den) && den !== 0) total += num / den;
            } else if (parts.length > 0) {
                total += parseFloat(parts[0]);
            }
            if (parts.length === 2 && parts[1].includes('/')) {
                const [num, den] = parts[1].split('/').map(Number);
                if (!isNaN(num) && !isNaN(den) && den !== 0) total += num / den;
            }
            return isNaN(total) ? NaN : total;
        };

        const roundToEighth = (num) => Math.floor(num * 8) / 8;

        const formatFraction = (num) => {
            if (isNaN(num) || num === null) return "";
            const whole = Math.floor(num);
            let fraction = Math.round((num - whole) * 8);
            if (fraction === 0) return `${whole}`;
            if (fraction === 8) return `${whole + 1}`;
            const gcd = (a, b) => b ? gcd(b, a % b) : a;
            const divisor = gcd(fraction, 8);
            const numerator = fraction / divisor;
            const denominator = 8 / divisor;
            return whole > 0 ? `${whole} ${numerator}/${denominator}` : `${numerator}/${denominator}`;
        };

        const showStatusMessage = (message, isError = true) => {
            const { statusMessage } = DOMElements;
            statusMessage.textContent = message;
            statusMessage.className = `p-4 mb-6 text-center text-white rounded-lg transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => statusMessage.classList.add('hidden'), 4000);
        };

        const initializeFirebase = async () => {
            try {
                // =================================================================
                // PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE
                // =================================================================
                const firebaseConfig = {
  apiKey: "AIzaSyAPN6tazk0RkYa49XQgu6tAAHY_EF8XW8M",
  authDomain: "windows-measurments.firebaseapp.com",
  projectId: "windows-measurments",
  storageBucket: "windows-measurments.firebasestorage.app",
  messagingSenderId: "871418252288",
  appId: "1:871418252288:web:e250ae0a75764e9b405ce5",
  measurementId: "G-1HPL56D6JT"
};
                // =================================================================

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    showStatusMessage("Firebase is not configured. Please add your credentials.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                showStatusMessage("Database connected successfully!", false);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showStatusMessage(`Connection Error: ${error.message}`);
            }
        };

        const loadPO = () => {
            const poNumber = DOMElements.poNumberInput.value.trim();
            if (!poNumber) return showStatusMessage("Please enter a PO Number.");
            if (!db) return showStatusMessage("Database not connected. Cannot load PO.");

            if (unsubscribe) unsubscribe();
            currentPoNumber = poNumber;
            DOMElements.loadingIcon.classList.remove('hidden');
            DOMElements.loadPoBtn.disabled = true;

            const collectionPath = `artifacts/${appId}/public/data/measurements/${currentPoNumber}/windows`;
            const q = query(collection(db, collectionPath));

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                windows = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWindows();
                DOMElements.entryForm.classList.remove('opacity-50', 'pointer-events-none');
                DOMElements.currentPoInfo.textContent = `Loaded PO: ${currentPoNumber}. Found ${windows.length} window(s).`;
                DOMElements.loadingIcon.classList.add('hidden');
                DOMElements.loadPoBtn.disabled = false;
                showStatusMessage(`Successfully loaded PO: ${currentPoNumber}`, false);
            }, (error) => {
                console.error("Error fetching PO data: ", error);
                showStatusMessage("Error loading data. Check Firestore rules and network.");
                DOMElements.loadingIcon.classList.add('hidden');
                DOMElements.loadPoBtn.disabled = false;
            });
        };
        
        const renderWindows = () => {
            const { entriesContainer, generatePDFBtn } = DOMElements;
            entriesContainer.innerHTML = windows.length === 0 
                ? '<p class="text-gray-500">No windows added yet for this PO.</p>'
                : windows.map(w => {
                    let transomInfo = '';
                    if (w.transomHeight) {
                        const shape = w.transomShape || '';
                        transomInfo = `<p class="text-sm text-gray-600 font-medium">Transom: ${shape} - ${formatFraction(w.transomHeight)}"</p>`;
                    }
                    return `
                    <div class="bg-gray-50 border-l-4 border-[#9D2235] p-4 rounded-r-md shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg text-gray-800">${w.location}</p>
                                <p class="text-sm text-gray-600">${w.type}</p>
                                ${transomInfo}
                            </div>
                            <p class="font-bold text-xl text-[#9D2235]">${formatFraction(w.finalW)}" × ${formatFraction(w.finalH)}"</p>
                        </div>
                        ${w.notes ? `<p class="mt-2 text-sm text-gray-500 italic">Notes: ${w.notes}</p>` : ''}
                    </div>
                `}).join('');
            generatePDFBtn.disabled = windows.length === 0;
        };

        const calculateAndShowFinalSize = () => {
            const type = DOMElements.typeSelect.value;
            let finalW, finalH;

            if (['Round', 'Half-Round'].includes(type)) {
                const [w, h] = DOMElements.simpleMeasurementFields.map(id => parseFractionInput(document.getElementById(id).value));
                if (!isNaN(w) && w > 0 && !isNaN(h) && h > 0) {
                    finalW = w;
                    finalH = h;
                }
            } else {
                const values = DOMElements.detailedMeasurementFields.map(id => parseFractionInput(document.getElementById(id).value));
                if (values.every(v => !isNaN(v) && v > 0)) {
                    const rounded = values.map(roundToEighth);
                    finalW = Math.min(...rounded.slice(0, 3));
                    finalH = Math.min(...rounded.slice(3, 6));
                }
            }
            
            if (finalW && finalH) {
                DOMElements.finalSizeSpan.textContent = `${formatFraction(roundToEighth(finalW))}" × ${formatFraction(roundToEighth(finalH))}"`;
                DOMElements.finalSizeDisplay.classList.remove('hidden');
            } else {
                DOMElements.finalSizeDisplay.classList.add('hidden');
            }
        };

        const saveWindow = async () => {
            if (!currentPoNumber || !db) return showStatusMessage("Please load a PO before saving a window.");

            const location = DOMElements.locationInput.value.trim();
            let type = DOMElements.typeSelect.value;
            const customType = DOMElements.otherTypeInput.value.trim();
            if (type === 'Other') type = customType;

            if (!location || !type) return showStatusMessage("Please provide a location and window type.");

            let newWindow;
            const isSimple = ['Round', 'Half-Round'].includes(type);

            if (isSimple) {
                const [w, h] = DOMElements.simpleMeasurementFields.map(id => parseFractionInput(document.getElementById(id).value));
                if (isNaN(w) || !(w > 0) || isNaN(h) || !(h > 0)) return showStatusMessage("Please enter valid width and height.");
                newWindow = {
                    location, type,
                    notes: DOMElements.notesSimpleInput.value.trim(),
                    widths: [], heights: [], transomHeight: null, transomShape: null,
                    finalW: roundToEighth(w), finalH: roundToEighth(h)
                };
            } else {
                const values = DOMElements.detailedMeasurementFields.map(id => parseFractionInput(document.getElementById(id).value));
                if (values.some(v => isNaN(v) || !(v > 0))) return showStatusMessage("Please fill all measurement fields.");
                
                let transomHeight = null;
                let transomShape = null;
                if (DOMElements.transomCheckbox.checked) {
                    const th = parseFractionInput(DOMElements.transomHeightInput.value);
                    if (isNaN(th) || !(th > 0)) return showStatusMessage("Please enter a valid Transom Height.");
                    transomHeight = roundToEighth(th);

                    transomShape = DOMElements.transomShapeSelect.value;
                    if (transomShape === 'Other') {
                        transomShape = DOMElements.otherTransomShapeInput.value.trim();
                        if (!transomShape) return showStatusMessage("Please specify the 'Other' transom shape.");
                    }
                }

                const rounded = values.map(roundToEighth);
                newWindow = {
                    location, type, transomHeight, transomShape,
                    notes: DOMElements.notesInput.value.trim(),
                    widths: rounded.slice(0, 3),
                    heights: rounded.slice(3, 6),
                    finalW: Math.min(...rounded.slice(0, 3)),
                    finalH: Math.min(...rounded.slice(3, 6))
                };
            }

            DOMElements.addWindowBtn.disabled = true;
            DOMElements.addWindowBtn.textContent = 'Saving...';

            try {
                const collectionPath = `artifacts/${appId}/public/data/measurements/${currentPoNumber}/windows`;
                await addDoc(collection(db, collectionPath), { ...newWindow, createdAt: serverTimestamp() });
                showStatusMessage("Window saved successfully!", false);
                
                DOMElements.locationInput.value = '';
                DOMElements.typeSelect.value = '';
                DOMElements.typeSelect.dispatchEvent(new Event('change'));
                DOMElements.locationInput.focus();
            } catch (error) {
                console.error("Error adding document: ", error);
                showStatusMessage("Failed to save window. Check connection.");
            } finally {
                DOMElements.addWindowBtn.disabled = false;
                DOMElements.addWindowBtn.textContent = 'Save Window';
            }
        };

        const generatePDF = async () => {
            if (windows.length === 0) return showStatusMessage("No windows to export.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            
            const brandRed = [157, 34, 53];
            const lightGray = [243, 244, 246];
            const darkGray = [55, 65, 81];
            const midGray = [107, 114, 128];
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 40;
            const bottomMargin = 40;
            let y = margin;

            // Main Header
            doc.setFontSize(20);
            doc.setTextColor(brandRed[0], brandRed[1], brandRed[2]);
            doc.text('H&F Exteriors - Window Measurement Report', pageWidth / 2, y, { align: 'center' });
            y += 20;
            doc.setFontSize(12);
            doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
            doc.text(`PO Number: ${currentPoNumber}`, margin, y);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - margin, y, { align: 'right' });
            y += 25;

            windows.forEach((w) => {
                let blockStartY = y;

                // --- Calculate block height before drawing to handle page breaks ---
                let calculatedHeight = 85; // Initial height for header and main info
                if (w.transomHeight) calculatedHeight += 30;
                if (w.notes) {
                    const notesLines = doc.splitTextToSize(w.notes, pageWidth - margin * 2 - 20);
                    calculatedHeight += (notesLines.length * 10) + 25;
                }
                if (w.widths && w.widths.length > 0) calculatedHeight += 60;
                
                if (y + calculatedHeight > pageHeight - bottomMargin) {
                    doc.addPage();
                    y = margin;
                    blockStartY = y;
                }

                // --- Draw Block ---
                // Block Header
                doc.setFillColor(brandRed[0], brandRed[1], brandRed[2]);
                doc.rect(margin, y, pageWidth - (margin * 2), 30, 'F');
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text(`Window Location: ${w.location}`, margin + 10, y + 20);
                y += 30;

                // Main content area
                doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                doc.rect(margin, y, pageWidth - (margin * 2), calculatedHeight - 30, 'F');
                y += 15;

                // Type and Final Size side-by-side
                const halfWidth = pageWidth / 2;
                doc.setFontSize(11);
                doc.setTextColor(midGray[0], midGray[1], midGray[2]);
                doc.text('Type', halfWidth / 2 + margin / 2, y, { align: 'center' });
                doc.text('Final Size (Width × Height)', halfWidth + halfWidth / 2 - margin/2, y, { align: 'center' });
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text(w.type, halfWidth / 2 + margin / 2, y + 20, { align: 'center' });
                doc.text(`${formatFraction(w.finalW)}" × ${formatFraction(w.finalH)}"`, halfWidth + halfWidth / 2 - margin/2, y + 20, { align: 'center' });
                y += 40;

                // Transom Info
                if (w.transomHeight) {
                    doc.setFontSize(10);
                    doc.setTextColor(midGray[0], midGray[1], midGray[2]);
                    doc.text('Transom', margin + 10, y);
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    doc.text(`Shape: ${w.transomShape}`, margin + 20, y + 14);
                    doc.text(`Height: ${formatFraction(w.transomHeight)}"`, halfWidth, y + 14);
                    y += 30;
                }

                // Notes
                if (w.notes) {
                    doc.setFontSize(10);
                    doc.setTextColor(midGray[0], midGray[1], midGray[2]);
                    doc.text('Notes', margin + 10, y);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    const notesLines = doc.splitTextToSize(w.notes, pageWidth - (margin * 2) - 20);
                    doc.text(notesLines, margin + 20, y + 14);
                    y += (notesLines.length * 10) + 15;
                }

                // Reference Measurements
                if (w.widths && w.widths.length > 0) {
                    doc.setFontSize(10);
                    doc.setTextColor(midGray[0], midGray[1], midGray[2]);
                    doc.text('Reference Measurements', margin + 10, y);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                    const refText = [
                        `Width Top: ${formatFraction(w.widths[0])}"`,
                        `Width Middle: ${formatFraction(w.widths[1])}"`,
                        `Width Bottom: ${formatFraction(w.widths[2])}"`,
                        `Height Left: ${formatFraction(w.heights[0])}"`,
                        `Height Center: ${formatFraction(w.heights[1])}"`,
                        `Height Right: ${formatFraction(w.heights[2])}"`,
                    ];
                    doc.text(refText[0], margin + 20, y + 14);
                    doc.text(refText[1], margin + 20, y + 26);
                    doc.text(refText[2], margin + 20, y + 38);
                    doc.text(refText[3], pageWidth / 2, y + 14);
                    doc.text(refText[4], pageWidth / 2, y + 26);
                    doc.text(refText[5], pageWidth / 2, y + 38);
                    y += 50;
                }

                y = blockStartY + calculatedHeight + 15; // Move y to the end of the drawn block plus a margin
            });

            const fileName = `${currentPoNumber}_Window_Measurements.pdf`;
            const file = new File([doc.output('blob')], fileName, { type: 'application/pdf' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({ files: [file], title: fileName, text: `Window measurements for PO ${currentPoNumber}` });
                } catch (error) {
                    console.log('Share failed, falling back to download.', error);
                    doc.save(fileName);
                }
            } else {
                doc.save(fileName);
            }
        };
        
        const handleTypeChange = () => {
            const type = DOMElements.typeSelect.value;
            const isOther = type === 'Other';
            const isSimple = ['Round', 'Half-Round'].includes(type);
            const isDetailed = ['Single Hung', 'Double Hung', 'Picture', 'Casement', 'Other'].includes(type);
            const showTransomOption = ['Single Hung', 'Double Hung', 'Picture', 'Casement'].includes(type);

            DOMElements.otherTypeWrapper.classList.toggle('hidden', !isOther);
            DOMElements.otherTypeInput.required = isOther;
            if (isOther) DOMElements.otherTypeInput.focus();
            
            DOMElements.measurementContainer.classList.toggle('hidden', !type);
            DOMElements.simpleMeasurementContainer.classList.toggle('hidden', !isSimple);
            DOMElements.detailedMeasurementContainer.classList.toggle('hidden', !isDetailed);
            DOMElements.transomOptionContainer.classList.toggle('hidden', !showTransomOption);
            
            // Clear all inputs on type change
            [...DOMElements.detailedMeasurementFields, ...DOMElements.simpleMeasurementFields, 'transomHeight', 'otherTransomShape'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            DOMElements.transomCheckbox.checked = false;
            DOMElements.transomDetailsWrapper.classList.add('hidden');
            DOMElements.otherTransomShapeWrapper.classList.add('hidden');
            DOMElements.transomShapeSelect.value = 'Rectangular';
            DOMElements.notesInput.value = '';
            DOMElements.notesSimpleInput.value = '';
            DOMElements.otherTypeInput.value = '';
            DOMElements.finalSizeDisplay.classList.add('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            DOMElements.loadPoBtn.addEventListener('click', loadPO);
            DOMElements.addWindowBtn.addEventListener('click', saveWindow);
            DOMElements.generatePDFBtn.addEventListener('click', generatePDF);
            DOMElements.typeSelect.addEventListener('change', handleTypeChange);
            
            DOMElements.transomCheckbox.addEventListener('change', () => {
                const isChecked = DOMElements.transomCheckbox.checked;
                DOMElements.transomDetailsWrapper.classList.toggle('hidden', !isChecked);
                if (!isChecked) {
                    DOMElements.transomHeightInput.value = '';
                    DOMElements.transomShapeSelect.value = 'Rectangular';
                    DOMElements.otherTransomShapeInput.value = '';
                    DOMElements.otherTransomShapeWrapper.classList.add('hidden');
                }
            });

            DOMElements.transomShapeSelect.addEventListener('change', () => {
                const isOther = DOMElements.transomShapeSelect.value === 'Other';
                DOMElements.otherTransomShapeWrapper.classList.toggle('hidden', !isOther);
                if (!isOther) DOMElements.otherTransomShapeInput.value = '';
            });
            
            const allMeasurementFields = [...DOMElements.detailedMeasurementFields, ...DOMElements.simpleMeasurementFields, 'transomHeight'];
            allMeasurementFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', calculateAndShowFinalSize);
                    el.addEventListener('blur', () => {
                        const val = parseFractionInput(el.value);
                        if (!isNaN(val)) {
                            el.value = formatFraction(roundToEighth(val)); 
                        }
                        calculateAndShowFinalSize();
                    });
                }
            });
        });

    </script>
</body>
</html>
